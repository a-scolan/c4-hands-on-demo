model {
  customer = person 'Client'

  // --- TARGET SYSTEM ---
  vault = system 'Secure Vault System' {
    
    // 0. Frontend
    frontend = container 'Web UI' {
      technology 'React SPA'
      description 'Single Page Application'
    }

    // 1. Entry Point
    api = container 'API Gateway' {
      technology 'Kong / API Gateway'
      description 'Routes requests and validates auth'

      router = component 'Router' {
        technology 'Express Router'
      }

      auth = component 'Auth Middleware' {
        technology 'JWT'
      }
    }

    // 2. Upload Service
    uploadService = container 'Upload Service' {
      technology 'Node.js / Express'
      description 'Handles file uploads and validation'

      uploadHandler = component 'Upload Handler' {
        technology 'Multer / Express'
        description 'Receives and validates files'
      }

      fileValidator = component 'File Validator' {
        technology 'File Analysis'
        description 'Validates file type, size, and structure before queuing'
      }
    }

    // 3. Retrieval Service (merged Document + Download)
    retrievalService = container 'Retrieval Service' {
      technology 'GoLang'
      description 'Document metadata management and file retrieval with caching'

      retrievalHandler = component 'Retrieval Handler' {
        technology 'HTTP Handler'
        description 'Handles metadata queries and file retrieval requests'
      }

      cacheManager = component 'Cache Manager' {
        technology 'Redis Client'
        description 'Caches frequently accessed metadata and decrypted files'
      }

      decryptor = component 'Decryption Service' {
        technology 'AES-256'
        description 'Decrypts files for download'
      }
    }

    // 5. Async Buffer
    jobs = queue 'Processing Queue' {
	  #queue
      technology 'RabbitMQ'
    }

    // 6. Processing Worker
    worker = container 'Processing Worker' {
      technology 'GoLang'
      description 'Async file processing (scanning, encryption, storage)'

      consumer = component 'Queue Consumer' {
        technology 'RabbitMQ Client'
        description 'Receives jobs from queue'
      }

      orchestrator = component 'Job Orchestrator' {
        technology 'Workflow Engine'
        description 'Coordinates processing steps and error handling'
      }

      scannerClient = component 'Virus Scanner Client' {
        technology 'VirusTotal SDK'
        description 'Anti-virus scanning integration'
      }

      encryptor = component 'Encryption Service' {
        technology 'AES-256 GCM'
        description 'Encrypts files before storage'
      }

      s3Client = component 'S3 Client' {
        technology 'AWS SDK'
        description 'Handles file storage operations'
      }

      metadataWriter = component 'Metadata Writer' {
        technology 'MongoDB Driver'
        description 'Persists document metadata'
      }

      errorHandler = component 'Error Handler' {
        technology 'Dead Letter Queue'
        description 'Manages failed jobs and retries'
      }
    }

    // 7. Persistence
    docDB = database 'Document DB' {
      technology 'MongoDB'
    }
  }

  // --- INTERNAL STORAGE ---
  minio = system 'MinIO Object Storage' {
    description 'Primary encrypted object storage (on-premises) with 3-node replication'
  }

  // --- EXTERNAL DEPENDENCIES (Cloud / SaaS) ---
  scanner = system 'VirusTotal API' {
    #external
    #saas
    #security
    description 'SaaS Antivirus'
  }

  // --- REFACTORED RELATIONSHIPS ---
  
  // Client Access
  customer -[calls]-> frontend 'Access web interface'
  frontend -[calls]-> api 'All requests'

  // API Gateway Internal
  vault.api.router -[uses]-> vault.api.auth 'Authenticate requests'

  // Upload Flow - Validation BEFORE queuing (fail-fast)
  vault.api.router -[calls]-> uploadService 'Route upload requests'
  vault.uploadService.uploadHandler -[uses]-> vault.uploadService.fileValidator 'Validate file'
  vault.uploadService.fileValidator -[async]-> jobs 'Queue validated file for processing'

  // Worker Processing (Event-Driven - NO API calls TO worker)
  vault.worker.consumer -[async]-> jobs 'Consume upload jobs'
  vault.worker.consumer -[uses]-> vault.worker.orchestrator 'Delegate job'
  
  // Orchestrated Processing Pipeline (validation already done)
  vault.worker.orchestrator -[uses]-> vault.worker.scannerClient 'Scan for viruses'
  vault.worker.scannerClient -[calls]-> scanner 'Anti-virus check'
  vault.worker.orchestrator -[uses]-> vault.worker.encryptor 'Encrypt clean file'
  vault.worker.encryptor -[writes]-> docDB 'Store encryption key'
  vault.worker.orchestrator -[uses]-> vault.worker.s3Client 'Store file'
  vault.worker.s3Client -[writes]-> minio 'Save encrypted file (primary)'
  vault.worker.orchestrator -[uses]-> vault.worker.metadataWriter 'Update status'
  vault.worker.metadataWriter -[writes]-> docDB 'Save metadata as READY'
  
  // Error Handling
  vault.worker.orchestrator -[uses]-> vault.worker.errorHandler 'On failure'
  vault.worker.errorHandler -[writes]-> docDB 'Mark as FAILED'

  // Retrieval Flow - Unified service with caching
  vault.api.router -[calls]-> retrievalService 'Route list/download requests'
  vault.retrievalService.retrievalHandler -[uses]-> vault.retrievalService.cacheManager 'Check cache'
  vault.retrievalService.cacheManager -[reads]-> docDB 'Cache miss: fetch metadata'
  vault.retrievalService.retrievalHandler -[reads]-> minio 'Fetch encrypted file (primary)'
  vault.retrievalService.retrievalHandler -[uses]-> vault.retrievalService.decryptor 'Decrypt file'
  vault.retrievalService.decryptor -[reads]-> docDB 'Retrieve encryption key'
}
